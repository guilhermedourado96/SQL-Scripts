CREATE FUNCTION fnValidaCep (@CEP VARCHAR(9))  RETURNS BIT AS
BEGIN
	DECLARE @INTTOKEN		INT,
			@URL			VARCHAR(MAX),
			@JSON			VARCHAR(8000),
			@VALIDACAO		BIT 

	SET @CEP = REPLACE(@CEP,'-','');

	SET @URL = CONCAT('https://viacep.com.br/ws/',@CEP,'/json/')
	-- select servidor_id,* from tbparametro select db_name()
	EXEC SP_OACREATE 'MSXML2.XMLHTTP', @INTTOKEN OUT;
	/*CHAMADA PARA MÉTODO OPEN*/
	EXEC SP_OAMETHOD @INTTOKEN, 'OPEN', NULL, 'GET', @URL, 'FALSE';
	/*CHAMADA PARA MÉTODO SEND*/
	EXEC SP_OAMETHOD @INTTOKEN, 'SEND';
	/*CHAMADA PARA MÉTODO RESPONSE TEXT*/
	EXEC SP_OAMETHOD @INTTOKEN, 'RESPONSETEXT', @JSON OUTPUT;

	IF ISJSON(@JSON) = 1
		BEGIN
			IF (JSON_VALUE(@JSON, '$.cep') IS NOT NULL AND JSON_VALUE(@JSON, '$.logradouro') <> '')
				SET @VALIDACAO = 1
			ELSE 
				SET @VALIDACAO = 0
		END
	RETURN @VALIDACAO;
END
